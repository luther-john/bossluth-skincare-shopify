{%- assign section_link = section.settings.link_url -%}

<section
  class="flash-sale-timer"
  style="background: {{ section.settings.bg_color }}; color: {{ section.settings.text_color }};"
>
  {% if section_link != blank %}
    <a href="{{ section_link }}" style="text-decoration: none; color: inherit;">
  {% endif %}
  <div class="container">
    <h2>{{ section.settings.heading }}</h2>
    <div id="countdown-timer" data-date="{{ section.settings.end_date }}">
      <span id="days">00</span>d : <span id="hours">00</span>h : <span id="minutes">00</span>m :
      <span id="seconds">00</span>s
    </div>
  </div>
  {% if section_link != blank %}
    </a>
  {% endif %}
</section>

<section class="flash-sale-timer" style="background: {{ section.settings.bg_color }}; color: {{ section.settings.text_color }}; padding: 40px 0;">
  <div class="container" style="max-width: 600px; margin: 0 auto; text-align: center;">
    <h2>{{ section.settings.heading }}</h2>
    
    <div id="countdown-timer" 
         data-start="{{ section.settings.start_date }}" 
         data-end="{{ section.settings.end_date }}" 
         style="font-size: 2rem; font-weight: bold; margin-bottom: 20px;">
      <span id="days">00</span>d : <span id="hours">00</span>h : <span id="minutes">00</span>m : <span id="seconds">00</span>s
    </div>

    <div style="background: rgba(255,255,255,0.3); border-radius: 20px; height: 12px; width: 100%; overflow: hidden;">
      <div id="progress-bar" style="background: {{ section.settings.bar_color }}; height: 100%; width: 0%; transition: width 1s linear;"></div>
    </div>
  </div>
</section>

{% schema %}
{
  "name": "Flash Sale Timer",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Sale Ends In:" },
    { "type": "text", "id": "end_date", "label": "End Date (YYYY-MM-DD)", "default": "2026-12-31" },
    { "type": "color", "id": "bg_color", "label": "Background Color", "default": "#ff0000" },
    { "type": "color", "id": "text_color", "label": "Text Color", "default": "#ffffff" }
  ],
  "presets": [{ "name": "Flash Sale Timer" }]
}
{% endschema %}

<script>
  const targetDate = new Date(document.getElementById('countdown-timer').dataset.date).getTime();

  const timer = setInterval(function () {
    const now = new Date().getTime();
    const distance = targetDate - now;

    if (distance < 0) {
      clearInterval(timer);
      document.getElementById('countdown-timer').innerHTML = 'EXPIRED';
      return;
    }

    document.getElementById('days').innerText = Math.floor(distance / (1000 * 60 * 60 * 24));
    document.getElementById('hours').innerText = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    document.getElementById('minutes').innerText = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    document.getElementById('seconds').innerText = Math.floor((distance % (1000 * 60)) / 1000);
  }, 1000);
</script>

<script>
  function updateTimer() {
    const timerEl = document.getElementById('countdown-timer');
    const start = new Date(timerEl.dataset.start).getTime();
    const end = new Date(timerEl.dataset.end).getTime();
    const now = new Date().getTime();

    const totalDuration = end - start;
    const timePassed = now - start;
    const distance = end - now;

    if (distance < 0) {
      document.getElementById('progress-bar').style.width = "100%";
      timerEl.innerHTML = "SALE ENDED";
      return;
    }

    // Calculate Progress Percentage
    let progressPercent = (timePassed / totalDuration) * 100;
    progressPercent = Math.min(Math.max(progressPercent, 0), 100); // Keep between 0-100
    
    // Update Bar (We subtract from 100 if you want it to "deplete")
    document.getElementById('progress-bar').style.width = (100 - progressPercent) + "%";

    // Update Text
    document.getElementById('days').innerText = Math.floor(distance / (1000 * 60 * 60 * 24));
    document.getElementById('hours').innerText = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    document.getElementById('minutes').innerText = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    document.getElementById('seconds').innerText = Math.floor((distance % (1000 * 60)) / 1000);
  }

  setInterval(updateTimer, 1000);
  updateTimer(); // Run immediately on load
</script>
